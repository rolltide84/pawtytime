<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PawtyTime - Dog Potty Training Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(-25%); } 50% { transform: translateY(0); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-bounce { animation: bounce 1s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Mock storage using localStorage
        window.storage = {
            get: async (key) => {
                try {
                    const value = localStorage.getItem(key);
                    return value ? { value } : null;
                } catch { return null; }
            },
            set: async (key, value) => {
                try {
                    localStorage.setItem(key, value);
                    return { key, value };
                } catch { return null; }
            }
        };

        // Global state
        let state = {
            currentView: 'dashboard',
            dogs: [],
            selectedDog: null,
            events: [],
            meals: [],
            health: [],
            journal: [],
            expenses: [],
            customSchedules: {},
            completedScheduleItems: {},
            darkMode: false,
            isLoading: true,
            showAddDog: false,
            showLogger: false,
            showChat: false,
            showMealLogger: false,
            showScheduleEditor: false,
            notifications: [],
            chatMessages: [],
            chatInput: '',
            isSending: false,
            editingSchedule: [],
            dogForm: { name: '', breed: '', age: '', weight: '', size: '' },
            loggerForm: { notes: '', location: '', weather: '', indoorOutdoor: 'outdoor' },
            mealForm: { type: 'meal', amount: '', time: '' }
        };

        // Load data
        async function loadData() {
            try {
                const results = await Promise.all([
                    window.storage.get('dogs-v5'),
                    window.storage.get('events-v5'),
                    window.storage.get('meals-v5'),
                    window.storage.get('health-v5'),
                    window.storage.get('journal-v5'),
                    window.storage.get('expenses-v5'),
                    window.storage.get('customSchedules-v5'),
                    window.storage.get('completedScheduleItems-v5'),
                    window.storage.get('darkMode-v5')
                ]);

                if (results[0]?.value) {
                    state.dogs = JSON.parse(results[0].value);
                    if (state.dogs.length > 0) state.selectedDog = state.dogs[0].id;
                }
                if (results[1]?.value) state.events = JSON.parse(results[1].value);
                if (results[2]?.value) state.meals = JSON.parse(results[2].value);
                if (results[3]?.value) state.health = JSON.parse(results[3].value);
                if (results[4]?.value) state.journal = JSON.parse(results[4].value);
                if (results[5]?.value) state.expenses = JSON.parse(results[5].value);
                if (results[6]?.value) state.customSchedules = JSON.parse(results[6].value);
                if (results[7]?.value) state.completedScheduleItems = JSON.parse(results[7].value);
                if (results[8]?.value) state.darkMode = JSON.parse(results[8].value);
            } catch (error) {
                console.log('Loading initial data', error);
            }
            state.isLoading = false;
            render();
        }

        // Save data
        async function saveData() {
            try {
                await Promise.all([
                    window.storage.set('dogs-v5', JSON.stringify(state.dogs)),
                    window.storage.set('events-v5', JSON.stringify(state.events)),
                    window.storage.set('meals-v5', JSON.stringify(state.meals)),
                    window.storage.set('health-v5', JSON.stringify(state.health)),
                    window.storage.set('journal-v5', JSON.stringify(state.journal)),
                    window.storage.set('expenses-v5', JSON.stringify(state.expenses)),
                    window.storage.set('customSchedules-v5', JSON.stringify(state.customSchedules)),
                    window.storage.set('completedScheduleItems-v5', JSON.stringify(state.completedScheduleItems)),
                    window.storage.set('darkMode-v5', JSON.stringify(state.darkMode))
                ]);
            } catch (error) {
                console.error('Save failed:', error);
            }
        }

        // Add notification
        function addNotification(message) {
            state.notifications.push({ id: Date.now(), message, timestamp: new Date() });
            state.notifications = state.notifications.slice(-5);
            render();
            setTimeout(() => {
                state.notifications.shift();
                render();
            }, 3000);
        }

        // Core functions
        async function handleAddDog() {
            const { name, breed, age, weight, size } = state.dogForm;
            if (!name || !breed || !age || !weight || !size) {
                alert('Please fill in all fields');
                return;
            }

            const newDog = {
                id: Date.now().toString(),
                name, breed,
                age: parseInt(age),
                weight: parseInt(weight),
                size,
                addedDate: new Date().toISOString(),
                points: 0,
                badges: [],
                streak: 0,
                lastSuccessDate: null
            };

            state.dogs.push(newDog);
            state.selectedDog = newDog.id;
            state.showAddDog = false;
            state.dogForm = { name: '', breed: '', age: '', weight: '', size: '' };
            await saveData();
            addNotification(`${newDog.name} added successfully! üéâ`);
        }

        async function logEvent(eventType) {
            const newEvent = {
                id: Date.now().toString(),
                dogId: state.selectedDog,
                type: eventType,
                timestamp: new Date().toISOString(),
                notes: state.loggerForm.notes,
                location: state.loggerForm.location,
                weather: state.loggerForm.weather,
                indoorOutdoor: state.loggerForm.indoorOutdoor
            };

            state.events.push(newEvent);

            if (eventType === 'success') {
                state.dogs = state.dogs.map(d => {
                    if (d.id === state.selectedDog) {
                        const newPoints = d.points + 10;
                        const newBadges = [...d.badges];
                        
                        const lastDate = d.lastSuccessDate ? new Date(d.lastSuccessDate).toDateString() : null;
                        const today = new Date().toDateString();
                        const yesterday = new Date(Date.now() - 86400000).toDateString();
                        
                        let newStreak = d.streak;
                        if (lastDate === yesterday) {
                            newStreak++;
                        } else if (lastDate !== today) {
                            newStreak = 1;
                        }
                        
                        if (newPoints >= 50 && !newBadges.includes('first-steps')) newBadges.push('first-steps');
                        if (newPoints >= 100 && !newBadges.includes('potty-pro')) newBadges.push('potty-pro');
                        if (newPoints >= 250 && !newBadges.includes('master-trainer')) newBadges.push('master-trainer');
                        if (newStreak >= 7 && !newBadges.includes('week-warrior')) newBadges.push('week-warrior');
                        if (newStreak >= 30 && !newBadges.includes('month-master')) newBadges.push('month-master');
                        
                        return { ...d, points: newPoints, badges: newBadges, streak: newStreak, lastSuccessDate: today };
                    }
                    return d;
                });
                
                addNotification('Success logged! +10 points ‚ú®');
            }

            state.showLogger = false;
            state.loggerForm = { notes: '', location: '', weather: '', indoorOutdoor: 'outdoor' };
            await saveData();
        }

        async function quickLogSuccess(reason, scheduleTime = null) {
            const newEvent = {
                id: Date.now().toString(),
                dogId: state.selectedDog,
                type: 'success',
                timestamp: new Date().toISOString(),
                notes: reason,
                location: '',
                weather: '',
                indoorOutdoor: 'outdoor'
            };

            state.events.push(newEvent);

            if (scheduleTime) {
                const today = new Date().toDateString();
                const key = `${state.selectedDog}-${today}`;
                if (!state.completedScheduleItems[key]) {
                    state.completedScheduleItems[key] = [];
                }
                if (!state.completedScheduleItems[key].includes(scheduleTime)) {
                    state.completedScheduleItems[key].push(scheduleTime);
                }
            }

            state.dogs = state.dogs.map(d => {
                if (d.id === state.selectedDog) {
                    const newPoints = d.points + 10;
                    const today = new Date().toDateString();
                    let newStreak = d.streak;
                    const lastDate = d.lastSuccessDate ? new Date(d.lastSuccessDate).toDateString() : null;
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    
                    if (lastDate === yesterday) {
                        newStreak++;
                    } else if (lastDate !== today) {
                        newStreak = 1;
                    }
                    
                    return { ...d, points: newPoints, streak: newStreak, lastSuccessDate: today };
                }
                return d;
            });

            await saveData();
            addNotification('Success logged! +10 points ‚ú®');
        }

        async function logMeal() {
            const newMeal = {
                id: Date.now().toString(),
                dogId: state.selectedDog,
                type: state.mealForm.type,
                amount: state.mealForm.amount,
                timestamp: state.mealForm.time || new Date().toISOString()
            };
            state.meals.push(newMeal);
            state.showMealLogger = false;
            state.mealForm = { type: 'meal', amount: '', time: '' };
            
            const currentDog = state.dogs.find(d => d.id === state.selectedDog);
            if (currentDog && state.mealForm.type === 'meal') {
                const predictedTime = new Date(Date.now() + (45 * 60 * 1000));
                addNotification(`${currentDog.name} will likely need to go around ${predictedTime.toLocaleTimeString()}`);
            }
            await saveData();
        }

        function getSchedule() {
            const dog = state.dogs.find(d => d.id === state.selectedDog);
            if (!dog) return [];

            if (state.customSchedules[dog.id]) {
                return state.customSchedules[dog.id];
            }

            const baseIntervals = dog.age <= 3 ? 2 : dog.age <= 6 ? 3 : 4;
            const schedule = [];

            schedule.push({ time: '7:00 AM', reason: 'Morning wake-up', priority: 'high' });

            let currentTime = 7;
            for (let i = 0; i < 24 / baseIntervals; i++) {
                currentTime += baseIntervals;
                if (currentTime < 22) {
                    const hour = currentTime > 12 ? currentTime - 12 : currentTime;
                    const period = currentTime >= 12 ? 'PM' : 'AM';
                    schedule.push({
                        time: `${hour}:00 ${period}`,
                        reason: 'Regular interval',
                        priority: 'medium'
                    });
                }
            }

            schedule.push({ time: '10:00 PM', reason: 'Before bedtime', priority: 'high' });
            return schedule;
        }

        function isScheduleItemCompleted(time) {
            const today = new Date().toDateString();
            const key = `${state.selectedDog}-${today}`;
            const completed = state.completedScheduleItems[key] || [];
            return completed.includes(time);
        }

        function getSuccessRate() {
            const dogEvents = state.events.filter(e => e.dogId === state.selectedDog);
            const successes = dogEvents.filter(e => e.type === 'success').length;
            return dogEvents.length > 0 ? Math.round((successes / dogEvents.length) * 100) : 0;
        }

        function getIndoorAccidentRate() {
            const accidents = state.events.filter(e => e.dogId === state.selectedDog && e.type === 'accident');
            const indoorAccidents = accidents.filter(e => e.indoorOutdoor === 'indoor');
            return accidents.length > 0 ? Math.round((indoorAccidents.length / accidents.length) * 100) : 0;
        }

        function getCurrentDog() {
            return state.dogs.find(d => d.id === state.selectedDog);
        }

        function exportData() {
            const currentDog = getCurrentDog();
            const dogEvents = state.events.filter(e => e.dogId === state.selectedDog);
            
            let csv = 'Date,Time,Type,Indoor/Outdoor,Location,Weather,Notes\n';
            dogEvents.forEach(e => {
                const date = new Date(e.timestamp);
                csv += `${date.toLocaleDateString()},${date.toLocaleTimeString()},${e.type},${e.indoorOutdoor || ''},${e.location || ''},${e.weather || ''},${e.notes || ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentDog?.name}_data.csv`;
            a.click();
            addNotification('Data exported! üìä');
        }

        function generateVetReport() {
            const currentDog = getCurrentDog();
            const dogEvents = state.events.filter(e => e.dogId === state.selectedDog);
            const dogHealth = state.health.filter(h => h.dogId === state.selectedDog);
            
            let report = `VETERINARY REPORT - ${currentDog.name}\n`;
            report += `Generated: ${new Date().toLocaleString()}\n\n`;
            report += `BASIC INFORMATION\n`;
            report += `Name: ${currentDog.name}\n`;
            report += `Breed: ${currentDog.breed}\n`;
            report += `Age: ${currentDog.age} months\n`;
            report += `Weight: ${currentDog.weight} lbs\n\n`;
            report += `TRAINING PROGRESS\n`;
            report += `Success Rate: ${getSuccessRate()}%\n`;
            report += `Indoor Accident Rate: ${getIndoorAccidentRate()}%\n`;
            report += `Current Streak: ${currentDog.streak} days\n\n`;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentDog.name}_Vet_Report.txt`;
            a.click();
            addNotification('Vet report generated! üè•');
        }

        async function sendChatMessage() {
            if (!state.chatInput.trim() || state.isSending) return;
            
            const currentDog = getCurrentDog();
            const userMessage = { role: 'user', content: state.chatInput };
            state.chatMessages.push(userMessage);
            const messageToSend = state.chatInput;
            state.chatInput = '';
            state.isSending = true;
            render();

            try {
                const context = currentDog ? `Training ${currentDog.name}, ${currentDog.age} months, ${currentDog.breed}. Streak: ${currentDog.streak} days. ` : '';
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [...state.chatMessages.filter(m => m.role !== 'assistant' || m.content !== 'Connection error. Please try again.'), { role: 'user', content: context + messageToSend }],
                        system: 'You are an expert dog trainer. Provide practical, encouraging advice. Keep responses concise.'
                    })
                });

                const data = await response.json();
                state.chatMessages.push({ role: 'assistant', content: data.content[0].text });
            } catch (error) {
                state.chatMessages.push({ role: 'assistant', content: 'Connection error. Please try again.' });
            }
            state.isSending = false;
            render();
        }

        function openScheduleEditor() {
            state.editingSchedule = JSON.parse(JSON.stringify(getSchedule()));
            state.showScheduleEditor = true;
            render();
        }

        async function saveCustomSchedule() {
            state.customSchedules[state.selectedDog] = state.editingSchedule;
            state.showScheduleEditor = false;
            await saveData();
            addNotification('Custom schedule saved! üìÖ');
        }

        function addScheduleSlot() {
            state.editingSchedule.push({
                time: '12:00 PM',
                reason: 'Custom break',
                priority: 'medium'
            });
            render();
        }

        function removeScheduleSlot(index) {
            state.editingSchedule = state.editingSchedule.filter((_, i) => i !== index);
            render();
        }

        function updateScheduleSlot(index, field, value) {
            state.editingSchedule[index][field] = value;
            render();
        }

        async function resetToAISchedule() {
            delete state.customSchedules[state.selectedDog];
            state.showScheduleEditor = false;
            await saveData();
            addNotification('Reset to AI schedule! ü§ñ');
        }

        // Event handlers exposed globally
        window.toggleDarkMode = function() {
            state.darkMode = !state.darkMode;
            saveData();
            render();
        };

        window.selectDog = function(dogId) {
            state.selectedDog = dogId;
            render();
        };

        window.setView = function(view) {
            state.currentView = view;
            render();
        };

        window.showAddDogModal = function() {
            state.showAddDog = true;
            render();
        };

        window.closeAddDogModal = function() {
            state.showAddDog = false;
            state.dogForm = { name: '', breed: '', age: '', weight: '', size: '' };
            render();
        };

        window.submitAddDog = function() {
            state.dogForm = {
                name: document.getElementById('dogName').value,
                breed: document.getElementById('dogBreed').value,
                age: document.getElementById('dogAge').value,
                weight: document.getElementById('dogWeight').value,
                size: document.getElementById('dogSize').value
            };
            handleAddDog();
        };

        window.showLoggerModal = function() {
            state.showLogger = true;
            render();
        };

        window.closeLoggerModal = function() {
            state.showLogger = false;
            state.loggerForm = { notes: '', location: '', weather: '', indoorOutdoor: 'outdoor' };
            render();
        };

        window.setLoggerIndoorOutdoor = function(value) {
            state.loggerForm.indoorOutdoor = value;
            render();
        };

        window.submitLogSuccess = function() {
            state.loggerForm.location = document.getElementById('loggerLocation')?.value || '';
            state.loggerForm.notes = document.getElementById('loggerNotes')?.value || '';
            logEvent('success');
        };

        window.quickLogSuccess = function(reason, scheduleTime) {
            quickLogSuccess(reason, scheduleTime);
        };

        window.showMealLoggerModal = function() {
            state.showMealLogger = true;
            render();
        };

        window.closeMealLoggerModal = function() {
            state.showMealLogger = false;
            state.mealForm = { type: 'meal', amount: '', time: '' };
            render();
        };

        window.submitLogMeal = function() {
            state.mealForm.type = document.getElementById('mealType').value;
            state.mealForm.amount = document.getElementById('mealAmount').value;
            logMeal();
        };

        window.showChatModal = function() {
            state.showChat = true;
            render();
        };

        window.closeChatModal = function() {
            state.showChat = false;
            render();
        };

        window.submitChatMessage = function() {
            state.chatInput = document.getElementById('chatInput').value;
            sendChatMessage();
        };

        window.updateChatInput = function(value) {
            state.chatInput = value;
        };

        window.handleChatKeyPress = function(e) {
            if (e.key === 'Enter') {
                window.submitChatMessage();
            }
        };

        window.openScheduleEditorModal = function() {
            openScheduleEditor();
        };

        window.closeScheduleEditorModal = function() {
            state.showScheduleEditor = false;
            render();
        };

        window.addScheduleSlotBtn = function() {
            addScheduleSlot();
        };

        window.removeScheduleSlotBtn = function(index) {
            removeScheduleSlot(index);
        };

        window.updateScheduleSlotField = function(index, field, value) {
            updateScheduleSlot(index, field, value);
        };

        window.saveCustomScheduleBtn = function() {
            saveCustomSchedule();
        };

        window.resetToAIScheduleBtn = function() {
            resetToAISchedule();
        };

        window.exportDataBtn = function() {
            exportData();
        };

        window.generateVetReportBtn = function() {
            generateVetReport();
        };

        // Render function
        function render() {
            const root = document.getElementById('root');
            const { darkMode, isLoading, dogs, showAddDog, showLogger, showChat, showMealLogger, showScheduleEditor, currentView, notifications } = state;

            const bgClass = darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-violet-50 via-purple-50 to-pink-50';
            const cardClass = darkMode ? 'bg-gray-800/70' : 'bg-white/70';
            const textClass = darkMode ? 'text-gray-100' : 'text-gray-800';
            const textSecondaryClass = darkMode ? 'text-gray-400' : 'text-gray-600';

            if (isLoading) {
                root.innerHTML = `
                    <div class="${bgClass} min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-20 h-20 border-4 border-violet-200 border-t-violet-600 rounded-full animate-spin mx-auto mb-4"></div>
                            <div class="text-xl font-semibold ${textClass}">Loading PawtyTime...</div>
                        </div>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="${bgClass} min-h-screen">
                    <!-- Header -->
                    <div class="sticky top-0 z-30 backdrop-blur-xl ${darkMode ? 'bg-gray-800/70' : 'bg-white/70'} border-b shadow-lg">
                        <div class="max-w-7xl mx-auto px-6 py-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-violet-600 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                                        <span class="text-white text-2xl">üêï</span>
                                    </div>
                                    <div>
                                        <h1 class="text-2xl font-bold bg-gradient-to-r from-violet-600 to-purple-600 bg-clip-text text-transparent">
                                            PawtyTime
                                        </h1>
                                        <p class="text-xs ${textSecondaryClass}">AI-Powered Training</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button onclick="toggleDarkMode()" class="p-2.5 rounded-xl transition-all shadow-sm ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-white/80 text-gray-600'}">
                                        ${darkMode ? '‚òÄÔ∏è' : 'üåô'}
                                    </button>
                                    ${dogs.length > 0 ? `
                                        <select onchange="selectDog(this.value)" class="${cardClass} px-4 py-2 rounded-xl font-medium shadow-sm ${textClass}">
                                            ${dogs.map(dog => `<option value="${dog.id}" ${dog.id === state.selectedDog ? 'selected' : ''}>${dog.name}</option>`).join('')}
                                        </select>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notifications -->
                    ${notifications.length > 0 ? `
                        <div class="bg-gradient-to-r from-amber-400 to-orange-400 text-white shadow-lg">
                            <div class="max-w-7xl mx-auto px-6 py-3">
                                <div class="flex items-center gap-3">
                                    <span>üîî</span>
                                    <span class="font-medium">${notifications[notifications.length - 1].message}</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="max-w-7xl mx-auto px-6 py-8">
            `;

            if (dogs.length === 0) {
                html += `
                    <div class="text-center py-20">
                        <div class="${darkMode ? 'bg-gray-700' : 'bg-gradient-to-br from-violet-100 to-purple-100'} w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-8 shadow-xl">
                            <span class="text-6xl">üêï</span>
                        </div>
                        <h2 class="text-4xl font-bold mb-4 bg-gradient-to-r from-violet-600 to-purple-600 bg-clip-text text-transparent">
                            Welcome to PawtyTime!
                        </h2>
                        <p class="${textSecondaryClass} mb-8 text-lg">
                            AI-powered dog potty training with indoor/outdoor tracking
                        </p>
                        <button onclick="showAddDogModal()" class="px-8 py-4 bg-gradient-to-r from-violet-600 to-purple-600 text-white rounded-2xl hover:shadow-2xl transform hover:scale-105 transition-all font-semibold text-lg">
                            ‚ûï Add Your Dog
                        </button>
                    </div>
                `;
            } else {
                const dog = getCurrentDog();
                
                // Stats
                html += `
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
                        ${[
                            { icon: 'üìà', label: 'Success Rate', value: `${getSuccessRate()}%` },
                            { icon: 'üèÜ', label: 'Points', value: dog?.points || 0 },
                            { icon: '‚ö°', label: 'Streak', value: `${dog?.streak || 0}d` },
                            { icon: 'üéØ', label: 'Successes', value: state.events.filter(e => e.dogId === state.selectedDog && e.type === 'success').length },
                            { icon: 'üè†', label: 'Indoor Rate', value: `${getIndoorAccidentRate()}%` },
                            { icon: 'üë•', label: 'Team', value: 1 }
                        ].map(stat => `
                            <div class="${cardClass} backdrop-blur-xl rounded-2xl p-6 shadow-lg">
                                <div class="text-2xl mb-2">${stat.icon}</div>
                                <div class="text-3xl font-bold ${textClass} mb-1">${stat.value}</div>
                                <div class="text-xs ${textSecondaryClass} font-medium">${stat.label}</div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Navigation -->
                    <div class="grid grid-cols-4 md:grid-cols-10 gap-3 mb-8">
                        ${[
                            { id: 'dashboard', icon: 'üè†', label: 'Home' },
                            { id: 'schedule', icon: 'üìÖ', label: 'Schedule' },
                            { id: 'progress', icon: 'üìä', label: 'Progress' },
                            { id: 'journal', icon: 'üìñ', label: 'Journal' },
                            { id: 'gallery', icon: 'üì∑', label: 'Gallery' },
                            { id: 'milestones', icon: 'üèÜ', label: 'Milestones' },
                            { id: 'challenges', icon: 'üî•', label: 'Challenges' },
                            { id: 'expenses', icon: 'üí∞', label: 'Expenses' },
                            { id: 'breed-db', icon: 'üêï', label: 'Breeds' },
                            { id: 'expert', icon: 'üìû', label: 'Experts' }
                        ].map(nav => `
                            <button onclick="setView('${nav.id}')" class="${currentView === nav.id ? 'bg-gradient-to-br from-violet-600 to-purple-600 text-white shadow-xl' : (darkMode ? 'bg-gray-700/70 text-gray-300' : 'bg-white/70 text-gray-700')} py-4 rounded-2xl font-semibold transition-all transform hover:scale-105">
                                <div class="text-2xl mb-2">${nav.icon}</div>
                                <div class="text-xs">${nav.label}</div>
                            </button>
                        `).join('')}
                    </div>
                `;

                // Dashboard view
                if (currentView === 'dashboard') {
                    html += `
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-6">
                                <div class="${cardClass} backdrop-blur-xl rounded-3xl p-8 shadow-xl">
                                    <h3 class="text-2xl font-bold ${textClass} mb-6">Quick Actions</h3>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <button onclick="showLoggerModal()" class="p-6 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-2xl text-white font-semibold hover:shadow-2xl transform hover:scale-105 transition-all">
                                            <div class="text-3xl mb-2">‚úÖ</div>
                                            <div>Log Success</div>
                                        </button>
                                        <button onclick="showLoggerModal()" class="p-6 bg-gradient-to-br from-red-500 to-orange-500 rounded-2xl text-white font-semibold hover:shadow-2xl transform hover:scale-105 transition-all">
                                            <div class="text-3xl mb-2">‚ùå</div>
                                            <div>Log Accident</div>
                                        </button>
                                        <button onclick="showMealLoggerModal()" class="p-6 bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl text-white font-semibold hover:shadow-2xl transform hover:scale-105 transition-all">
                                            <div class="text-3xl mb-2">üçΩÔ∏è</div>
                                            <div>Log Meal</div>
                                        </button>
                                        <button onclick="showChatModal()" class="p-6 bg-gradient-to-br from-violet-500 to-purple-500 rounded-2xl text-white font-semibold hover:shadow-2xl transform hover:scale-105 transition-all">
                                            <div class="text-3xl mb-2">üí¨</div>
                                            <div>AI Trainer</div>
                                        </button>
                                    </div>
                                </div>

                                <div class="${cardClass} backdrop-blur-xl rounded-3xl p-8 shadow-xl">
                                    <div class="flex items-center justify-between mb-6">
                                        <h3 class="text-2xl font-bold ${textClass}">Recent Activity</h3>
                                        ${getIndoorAccidentRate() > 0 ? `
                                            <div class="px-4 py-2 bg-red-100 rounded-xl">
                                                <div class="text-sm font-bold text-red-700">
                                                    üè† ${getIndoorAccidentRate()}% Indoor
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="space-y-3 max-h-96 overflow-y-auto">
                                        ${state.events.filter(e => e.dogId === state.selectedDog).slice(-10).reverse().map(event => `
                                            <div class="${darkMode ? 'bg-gray-700/50' : 'bg-gradient-to-r from-gray-50 to-white'} p-4 rounded-2xl">
                                                <div class="font-semibold ${textClass}">
                                                    ${event.type === 'success' ? '‚úÖ Success' : '‚ùå Accident'}
                                                    ${event.indoorOutdoor ? `<span class="ml-2 px-3 py-1 rounded-full text-xs font-bold ${event.indoorOutdoor === 'indoor' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${event.indoorOutdoor === 'indoor' ? 'üè† Indoor' : 'üå≥ Outdoor'}</span>` : ''}
                                                </div>
                                                <div class="text-sm ${textSecondaryClass}">${new Date(event.timestamp).toLocaleString()}</div>
                                                ${event.notes ? `<div class="text-sm ${textSecondaryClass} mt-2">${event.notes}</div>` : ''}
                                            </div>
                                        `).join('') || '<p class="text-center py-8 text-gray-500">No activity yet. Start tracking!</p>'}
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <div class="relative bg-gradient-to-br from-violet-600 via-purple-600 to-fuchsia-600 rounded-3xl p-8 shadow-2xl text-white">
                                    <div class="text-center">
                                        <div class="text-6xl mb-4">üêï</div>
                                        <h3 class="text-3xl font-bold mb-2">${dog.name}</h3>
                                        <div class="text-white/90">${dog.age} months ‚Ä¢ ${dog.breed}</div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="exportDataBtn()" class="bg-gray-800 text-white p-4 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all font-bold">
                                        <div class="text-2xl mb-1">üì•</div>
                                        <div class="text-xs">Export</div>
                                    </button>
                                    <button onclick="generateVetReportBtn()" class="bg-gradient-to-r from-red-600 to-pink-600 text-white p-4 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all font-bold">
                                        <div class="text-2xl mb-1">üìÑ</div>
                                        <div class="text-xs">Vet Report</div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Schedule view
                if (currentView === 'schedule') {
                    const schedule = getSchedule();
                    html += `
                        <div class="${cardClass} backdrop-blur-xl rounded-3xl p-8 shadow-xl">
                            <div class="flex items-center justify-between mb-8">
                                <div>
                                    <h3 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent mb-2">
                                        Smart Schedule
                                    </h3>
                                    <p class="${textSecondaryClass}">
                                        ${state.customSchedules[state.selectedDog] ? '‚úèÔ∏è Custom schedule active' : `AI-optimized for ${dog.name}`}
                                    </p>
                                </div>
                                <button onclick="openScheduleEditorModal()" class="px-6 py-3 bg-gradient-to-r from-violet-600 to-purple-600 text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all font-semibold">
                                    ‚úèÔ∏è Edit Schedule
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                ${schedule.map(item => {
                                    const isCompleted = isScheduleItemCompleted(item.time);
                                    return `
                                        <div class="flex items-center gap-5 p-5 rounded-2xl ${isCompleted ? (darkMode ? 'bg-gray-700/30 opacity-60' : 'bg-green-50/50 opacity-70') : (item.priority === 'high' ? 'bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200' : (darkMode ? 'bg-gray-700/50' : 'bg-gradient-to-r from-blue-50 to-cyan-50'))}">
                                            <div class="w-28 font-bold text-lg ${isCompleted ? 'line-through text-gray-400' : 'text-blue-700'}">
                                                ${item.time}
                                            </div>
                                            <div class="flex-1">
                                                <div class="font-semibold ${isCompleted ? 'line-through text-gray-400' : textClass}">
                                                    ${item.reason}
                                                </div>
                                                ${item.priority === 'high' && !isCompleted ? '<div class="text-xs text-red-600 font-medium mt-1">High Priority</div>' : ''}
                                                ${isCompleted ? '<div class="text-xs text-green-600 font-medium mt-1">‚úì Completed</div>' : ''}
                                            </div>
                                            ${isCompleted ? `
                                                <div class="px-6 py-3 bg-green-100 text-green-700 rounded-xl font-semibold">
                                                    ‚úì Done
                                                </div>
                                            ` : `
                                                <button onclick="quickLogSuccess('Scheduled: ${item.reason}', '${item.time}')" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all font-semibold">
                                                    Done ‚úì
                                                </button>
                                            `}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                // Progress view
                if (currentView === 'progress') {
                    html += `
                        <div class="${cardClass} backdrop-blur-xl rounded-3xl p-8 shadow-xl">
                            <h3 class="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent mb-8">
                                7-Day Progress
                            </h3>
                            <p class="${textClass}">Progress charts will display here with Recharts library integration.</p>
                        </div>
                    `;
                }
            }

            html += `
                    </div>
                </div>
            `;

            // Modals
            if (showAddDog) {
                const { dogForm } = state;
                html += `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                        <div class="${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-8 max-w-md w-full">
                            <h3 class="text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}">Add Your Dog</h3>
                            <div class="space-y-4">
                                <input id="dogName" value="${dogForm.name}" placeholder="Dog's name" class="w-full px-5 py-3 border-2 rounded-xl" />
                                <input id="dogBreed" value="${dogForm.breed}" placeholder="Breed" class="w-full px-5 py-3 border-2 rounded-xl" />
                                <input id="dogAge" value="${dogForm.age}" type="number" placeholder="Age (months)" class="w-full px-5 py-3 border-2 rounded-xl" />
                                <input id="dogWeight" value="${dogForm.weight}" type="number" placeholder="Weight (lbs)" class="w-full px-5 py-3 border-2 rounded-xl" />
                                <select id="dogSize" class="w-full px-5 py-3 border-2 rounded-xl">
                                    <option value="">Select size</option>
                                    <option value="small" ${dogForm.size === 'small' ? 'selected' : ''}>Small</option>
                                    <option value="medium" ${dogForm.size === 'medium' ? 'selected' : ''}>Medium</option>
                                    <option value="large" ${dogForm.size === 'large' ? 'selected' : ''}>Large</option>
                                </select>
                            </div>
                            <div class="flex gap-4 mt-8">
                                <button onclick="closeAddDogModal()" class="flex-1 px-6 py-3 bg-gray-100 rounded-xl font-semibold">Cancel</button>
                                <button onclick="submitAddDog()" class="flex-1 px-6 py-3 bg-gradient-to-r from-violet-600 to-purple-600 text-white rounded-xl font-semibold">Add Dog</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (showLogger) {
                const { loggerForm } = state;
                html += `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                        <div class="${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-8 max-w-md w-full">
                            <h3 class="text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}">Log Event</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="setLoggerIndoorOutdoor('outdoor')" class="${loggerForm.indoorOutdoor === 'outdoor' ? 'bg-green-500 text-white scale-105' : 'bg-gray-100'} py-4 rounded-xl font-bold transition-all">
                                        üå≥ Outdoor
                                    </button>
                                    <button onclick="setLoggerIndoorOutdoor('indoor')" class="${loggerForm.indoorOutdoor === 'indoor' ? 'bg-red-500 text-white scale-105' : 'bg-gray-100'} py-4 rounded-xl font-bold transition-all">
                                        üè† Indoor
                                    </button>
                                </div>
                                <select id="loggerLocation" class="w-full px-5 py-3 border-2 rounded-xl">
                                    <option value="">Select location</option>
                                    <option value="Living Room">Living Room</option>
                                    <option value="Kitchen">Kitchen</option>
                                    <option value="Backyard">Backyard</option>
                                    <option value="Near Door">Near Door</option>
                                </select>
                                <textarea id="loggerNotes" placeholder="Notes (optional)" class="w-full px-5 py-3 border-2 rounded-xl" rows="3">${loggerForm.notes}</textarea>
                            </div>
                            <div class="flex gap-4 mt-6">
                                <button onclick="closeLoggerModal()" class="flex-1 px-6 py-3 bg-gray-100 rounded-xl font-semibold">Cancel</button>
                                <button onclick="submitLogSuccess()" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">Log Success</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (showMealLogger) {
                const { mealForm } = state;
                html += `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                        <div class="${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-8 max-w-md w-full">
                            <h3 class="text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}">Log Meal</h3>
                            <div class="space-y-4">
                                <select id="mealType" class="w-full px-5 py-3 border-2 rounded-xl">
                                    <option value="meal" ${mealForm.type === 'meal' ? 'selected' : ''}>Full Meal</option>
                                    <option value="snack" ${mealForm.type === 'snack' ? 'selected' : ''}>Snack</option>
                                    <option value="treat" ${mealForm.type === 'treat' ? 'selected' : ''}>Treat</option>
                                </select>
                                <input id="mealAmount" value="${mealForm.amount}" placeholder="Amount (cups/pieces)" class="w-full px-5 py-3 border-2 rounded-xl" />
                            </div>
                            <div class="flex gap-4 mt-6">
                                <button onclick="closeMealLoggerModal()" class="flex-1 px-6 py-3 bg-gray-100 rounded-xl font-semibold">Cancel</button>
                                <button onclick="submitLogMeal()" class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-600 to-orange-600 text-white rounded-xl font-semibold">Log Meal</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (showChat) {
                html += `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                        <div class="${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-8 max-w-2xl w-full max-h-[80vh] flex flex-col">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}">AI Trainer</h3>
                                <button onclick="closeChatModal()" class="text-2xl">‚ùå</button>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto space-y-4 mb-4">
                                ${state.chatMessages.map(msg => `
                                    <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                                        <div class="max-w-[80%] px-5 py-3 rounded-2xl ${msg.role === 'user' ? 'bg-gradient-to-r from-violet-600 to-purple-600 text-white' : (darkMode ? 'bg-gray-700 text-gray-100' : 'bg-gray-100 text-gray-800')}">
                                            ${msg.content}
                                        </div>
                                    </div>
                                `).join('')}
                                ${state.isSending ? `
                                    <div class="flex justify-start">
                                        <div class="${darkMode ? 'bg-gray-700' : 'bg-gray-100'} px-5 py-3 rounded-2xl">
                                            <div class="flex gap-2">
                                                <div class="w-2 h-2 bg-violet-600 rounded-full animate-bounce"></div>
                                                <div class="w-2 h-2 bg-violet-600 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                                                <div class="w-2 h-2 bg-violet-600 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <div class="flex gap-3">
                                <input id="chatInput" value="${state.chatInput}" oninput="updateChatInput(this.value)" onkeypress="handleChatKeyPress(event)" placeholder="Ask about training..." class="flex-1 px-5 py-3 ${darkMode ? 'bg-gray-700' : 'bg-white'} border-2 rounded-xl" />
                                <button onclick="submitChatMessage()" ${state.isSending ? 'disabled' : ''} class="px-6 py-3 bg-gradient-to-r from-violet-600 to-purple-600 text-white rounded-xl font-semibold ${state.isSending ? 'opacity-50' : ''}">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (showScheduleEditor) {
                html += `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                        <div class="${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}">Edit Schedule</h3>
                                <button onclick="closeScheduleEditorModal()" class="text-2xl">‚ùå</button>
                            </div>
                            
                            <div class="space-y-3 mb-6">
                                ${state.editingSchedule.map((item, idx) => `
                                    <div class="${darkMode ? 'bg-gray-700/50' : 'bg-gray-50'} p-4 rounded-xl flex items-center gap-3">
                                        <input type="time" value="${item.time}" onchange="updateScheduleSlotField(${idx}, 'time', this.value)" class="px-3 py-2 ${darkMode ? 'bg-gray-600' : 'bg-white'} border rounded-lg" />
                                        <input type="text" value="${item.reason}" onchange="updateScheduleSlotField(${idx}, 'reason', this.value)" class="flex-1 px-3 py-2 ${darkMode ? 'bg-gray-600' : 'bg-white'} border rounded-lg" />
                                        <select value="${item.priority}" onchange="updateScheduleSlotField(${idx}, 'priority', this.value)" class="px-3 py-2 ${darkMode ? 'bg-gray-600' : 'bg-white'} border rounded-lg">
                                            <option value="high">High</option>
                                            <option value="medium">Medium</option>
                                            <option value="low">Low</option>
                                        </select>
                                        <button onclick="removeScheduleSlotBtn(${idx})" class="text-red-500 text-xl">‚ùå</button>
                                    </div>
                                `).join('')}
                            </div>

                            <button onclick="addScheduleSlotBtn()" class="w-full py-3 mb-6 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-xl font-semibold">
                                ‚ûï Add Time Slot
                            </button>

                            <div class="flex gap-3">
                                <button onclick="resetToAIScheduleBtn()" class="flex-1 px-6 py-3 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-xl font-semibold">
                                    Reset to AI
                                </button>
                                <button onclick="saveCustomScheduleBtn()" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-xl font-semibold">
                                    Save Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // FAB for adding more dogs
            if (dogs.length > 0) {
                html += `
                    <button onclick="showAddDogModal()" class="fixed bottom-8 right-8 w-16 h-16 bg-gradient-to-br from-violet-600 to-purple-600 text-white rounded-2xl shadow-2xl hover:shadow-3xl transform hover:scale-110 transition-all flex items-center justify-center z-40 text-3xl">
                        ‚ûï
                    </button>
                `;
            }

            root.innerHTML = html;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
    </script>
</body>
</html>
